USE master
GO

--VALIDO SI LA BD EXISTE
IF DB_ID('RENTCAR') IS NOT NULL
BEGIN	
	DROP DATABASE RENTCAR
END
GO

--CREACIÓN DE LA BD RENT-CAR
CREATE DATABASE RENTCAR
GO

USE RENTCAR
GO

--CONFIGURO FECHA DIA MES Y AÑO
SET DATEFORMAT DMY
GO

--GENERACION TABLAS QUE FORMAN PARTE DE LA BD RENTCAR
CREATE TABLE Cliente(
	IDE_CLI CHAR(5) NOT NULL, 
	APE_CLI VARCHAR(30) NOT NULL,
	NOM_CLI VARCHAR(30) NOT NULL,
	DNI_CLI	CHAR(8) NOT NULL,
	TEL_CLI VARCHAR(25) NULL DEFAULT '00-000-0000000',
	IDE_DIS CHAR(3) NOT NULL
)
GO

CREATE TABLE Distrito(
	IDE_DIS		CHAR(3)		NOT NULL,
	DES_DIS		VARCHAR(40)	NOT NULL
)
GO

CREATE TABLE Automovil(
	MAT_AUT		CHAR(10)		NOT NULL,
	COL_AUT		VARCHAR(30)		NOT NULL CHECK (COL_AUT IN('ROJO','PLATA','NEGRO','AZUL NOCHE')),
	MOD_AUT		VARCHAR(30)		NOT NULL
)
GO

CREATE TABLE Alquiler(
	NUM_ALQ		INT		NOT NULL,
	FEC_ALQ		DATE	NOT NULL,
	MON_ALQ		MONEY 	NOT NULL CHECK (MON_ALQ>0) 
)
GO

CREATE TABLE DetalleAlquiler(
	NUM_ALQ		INT			NOT NULL,
	IDE_CLI		CHAR(5)		NOT NULL,
	MAT_AUT		CHAR(10)	NOT NULL	
)
GO

--GENERACIÓN DE CLAVES PRIMARIAS
ALTER TABLE Cliente
	ADD PRIMARY KEY (IDE_CLI)
ALTER TABLE Automovil
	ADD PRIMARY KEY (MAT_AUT)
ALTER TABLE Alquiler
	ADD PRIMARY KEY (NUM_ALQ)
ALTER TABLE Distrito
	ADD PRIMARY KEY (IDE_DIS)
ALTER TABLE DetalleAlquiler
	ADD PRIMARY KEY (NUM_ALQ,IDE_CLI,MAT_AUT)

--GENERACION DE CLAVES FORÁNEAS

ALTER TABLE DetalleAlquiler
	ADD FOREIGN KEY (NUM_ALQ) REFERENCES Alquiler
ALTER TABLE DetalleAlquiler
	ADD FOREIGN KEY (IDE_CLI) REFERENCES Cliente
ALTER TABLE DetalleAlquiler
	ADD FOREIGN KEY (MAT_AUT) REFERENCES Automovil
ALTER TABLE Cliente
	ADD FOREIGN KEY (IDE_DIS) REFERENCES Distrito

GO

--AGREGAR EL ATRIBUTO CORREO DEL CLIENTE "COR_CLI" A LA TABLA CLIENTE

ALTER TABLE Cliente
	ADD COR_CLI VARCHAR(50) NULL
GO

--Insertando los registros a la table DISTRITO
INSERT INTO DISTRITO VALUES('L01','LIMA')
INSERT INTO DISTRITO VALUES('L02','LINCE')
INSERT INTO DISTRITO VALUES('L03','BREÑA')
INSERT INTO DISTRITO VALUES('L04','LOS OLIVOS')
INSERT INTO DISTRITO VALUES('L05','RIMAC')
INSERT INTO DISTRITO VALUES('L06','SAN MARTIN DE PORRES')
INSERT INTO DISTRITO VALUES('L07','SAN LUIS')
INSERT INTO DISTRITO VALUES('L08','SAN BORJA')


--Insertando los registros a la table Cliente
INSERT INTO CLIENTE VALUES('CL001','LOPEZ','MARIA','10856985','526-5254','L03','')
INSERT INTO CLIENTE VALUES('CL002','GOMEZ','JOSE','02188525','585-8212','L02','')
INSERT INTO CLIENTE VALUES('CL003','ACOSTA','JESUS','07415482','485-1598','L01','')
INSERT INTO CLIENTE VALUES('CL004','ARIAS','GUADSLUPE','08995255','258-8569','L04','')
INSERT INTO CLIENTE VALUES('CL005','CARLOS','MANUEL','10418525','296-9685','L08','')
INSERT INTO CLIENTE VALUES('CL006','GERZ','BRIGITTE','10952155','585-1254','L06','')
INSERT INTO CLIENTE VALUES('CL007','BARBOSA','MARISOL','78514855','584-5869','L04','')


--Insertando los registros a la table ALQUILER
INSERT INTO ALQUILER VALUES('1','12/03/10',185)
INSERT INTO ALQUILER VALUES('2','02/01/11',100)
INSERT INTO ALQUILER VALUES('3','01/05/11',54)
INSERT INTO ALQUILER VALUES('4','11/08/12',85)
INSERT INTO ALQUILER VALUES('5','22/06/12',18)
INSERT INTO ALQUILER VALUES('6','30/01/12',15)
INSERT INTO ALQUILER VALUES('7','16/04/12',165)
INSERT INTO ALQUILER VALUES('8','23/05/12',135)
INSERT INTO ALQUILER VALUES('9','21/03/12',225)


--Insertando los registros a la table AUTOMOVIL
INSERT INTO AUTOMOVIL VALUES('AF-456','ROJO','SEDAN')
INSERT INTO AUTOMOVIL VALUES('D4-243','NEGRO','SEDAN')
INSERT INTO AUTOMOVIL VALUES('H5-455','ROJO','STATION WAGON')
INSERT INTO AUTOMOVIL VALUES('GG-654','ROJO','CAMIONETA')
INSERT INTO AUTOMOVIL VALUES('FD-463','PLATA','STATION WAGON')
INSERT INTO AUTOMOVIL VALUES('SF-112','ROJO','LI')
INSERT INTO AUTOMOVIL VALUES('FG-654','AZUL NOCHE','L10')
INSERT INTO AUTOMOVIL VALUES('GT-532','ROJO','SEDAN')
INSERT INTO AUTOMOVIL VALUES('YT-457','NEGRO','STATION WAGON')

--Insertando detalle de alquiler
INSERT INTO DETALLEALQUILER VALUES('1','CL002','GG-654')
INSERT INTO DETALLEALQUILER VALUES('2','CL002','GT-532')
INSERT INTO DETALLEALQUILER VALUES('3','CL006','FD-463')
INSERT INTO DETALLEALQUILER VALUES('3','CL007','GT-532')
INSERT INTO DETALLEALQUILER VALUES('4','CL005','H5-455')
INSERT INTO DETALLEALQUILER VALUES('5','CL004','SF-112')
INSERT INTO DETALLEALQUILER VALUES('6','CL004','YT-457')
INSERT INTO DETALLEALQUILER VALUES('7','CL003','GT-532')

GO

--CREACION VISTA CLIENTES-ALQUILERES
IF OBJECT_ID('vAlquileresClientes') IS NOT NULL
	DROP VIEW vAlquileresClientes
GO

CREATE VIEW vAlquileresClientes
AS
	SELECT DA.NUM_ALQ, CL.IDE_CLI, CL.APE_CLI + ' ' + CL.NOM_CLI AS [CLIENTE], DA.MAT_AUT, AU.COL_AUT, AU.MOD_AUT, AL.FEC_ALQ
	FROM DetalleAlquiler DA INNER JOIN Automovil AU ON DA.MAT_AUT = AU.MAT_AUT 
		INNER JOIN Cliente CL ON CL.IDE_CLI = DA.IDE_CLI
		INNER JOIN Alquiler AL ON AL.NUM_ALQ = DA.NUM_ALQ
GO
 
SELECT * FROM vAlquileresClientes vAlqCl
WHERE vAlqCl.MAT_AUT = 'GT-532'    
GO
